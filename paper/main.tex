\documentclass[pdftex,twocolumn,epjc3]{svjour3} 
\RequirePackage[T1]{fontenc}
\smartqed  % flush right qed marks, e.g. at end of proof
\RequirePackage{graphicx}
\RequirePackage{mathptmx}      % use Times fonts if available on your TeX system
\RequirePackage{flushend}
\RequirePackage[numbers,sort&compress]{natbib}
\RequirePackage[colorlinks,citecolor=blue,urlcolor=blue,linkcolor=blue]{hyperref}

\journalname{Eur. Phys. J. C}


\usepackage{amsmath,amssymb,amsfonts}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{float}
\usepackage{etoolbox}
\usepackage{url}
\usepackage{listings}
\usepackage{pdfpages}
\usepackage[english]{babel}
\usepackage{xcolor,colortbl}
\usepackage{scalerel}

\renewcommand{\sp}{SP}

\newcommand{\normal}{n}
\newcommand{\dispute}{d}
\newcommand{\abnormal}{\overline{n}}
\newcommand{\abdispute}{\overline{d}}

\newcommand{\PoD}{$\mathrm{PoD}$}
\newcommand{\PoP}{$\mathrm{PoP}$}
\newcommand{\cid}{$\mathrm{cid}$}

\newcommand{\floor}[1]{\left\lfloor #1 \right\rfloor}
\newcommand{\ceil}[1]{\left\lceil #1 \right\rceil}

\newcommand{\plus}{+}
\newcommand{\minus}{-}
\newcommand\neutral[1][.75]{\mathbin{\ThisStyle{\vcenter{\hbox{%
  \scalebox{#1}{$\SavedStyle\bullet$}}}}}%
}

\def\SINGLECOLUMN{SINGLE}
\def\DOUBLECOLUMN{DOUBLE}
\def\JOURNALIEEE{IEEE}
\def\JOURNALELS{ELS}

\newcommand\TITLE{Anonymous provision of privacy-sensitive services using blockchain and decentralised storage}
\newcommand\STANLONG{Stanis\l{}aw Bara{\'n}ski}
\newcommand\JULLONG{Julian Szyma{\'n}ski}
\newcommand\HIGILONG{Higinio Mora}
\newcommand\STAN{S. Bara{\'n}ski}
\newcommand\JUL{J. Szyma{\'n}ski}
\newcommand\HIGI{H. Mora}

\newcommand\ABSTRACT{
Lawyers, laboratories, auditors or banks often need data containing sensitive personal information to provide their services. Examples of sensitive services include genetic testing, paternity testing, STD testing, credit scoring or legal advice. 

The processing of personal data, especially when providing services involving sensitive data such as health records, biological material or legal documents, exposes both users and service providers (SPs) to privacy risks. SPs are at risk of violating GDPR, CPAA and other legal regulations, while customers are at risk of losing their privacy.

We observe that personal data is often only used for logistical purposes, such as payment or communication, and could be provided anonymously if such methods were available.

We present a solution that allows services to be provided without collecting personal data. We use anonymous payment methods such as cash and anonymous cryptocurrencies, blockchain to achieve fairness, and distributed content-addressable storage networks to deliver results.

Compared to other solutions, our protocol achieves anonymity with weaker assumptions, supports physical materials and conflict resolution, and does not require the customer to interact with the blockchain in conflict-free transactions, demonstrating better practicality.

In this work, we analyse the fairness of our protocol and implement it using Ethereum technology as a message board, Monero as an anonymous payment method, and Powergate (IPFS and Filecoin) as a decentralised storage network.
}


\newcommand\ACKNOWLEDGEMENTS{
The work has been supported partially by the founds of Department of Computer Architecture Faculty of Electronics, Telecommunications and Informatics, Gdańsk University of Technology.
}

\newcommand\LASTVISITED{(last visited Jan. 31, 2023)}

\begin{document}

\title{\TITLE}

\author{\STANLONG\thanksref{e1,addr1}
        \and \JULLONG{}\thanksref{e2,addr1}
        \and \HIGILONG{}\thanksref{e3,addr2}
}


\thankstext{e1}{e-mail: stanislaw.baranski@pg.edu.pl}
\thankstext{e2}{e-mail: julian.szymanski@pg.edu.pl}
\thankstext{e3}{e-mail: hmora@ua.es}

\institute{Department of Electronic, Telecommunication and Informatics, Gdansk University of Technology, Narutowicza 11/12 80-233 Gdansk Poland\label{addr1}
          \and
          Department of Computer Science Technology and Computation, University of Alicante, San Vicente del Raspeig, 03690 Alicante Spain \label{addr2}
}


\date{Received: date / Accepted: date}
% The correct dates will be entered by the editor

\maketitle

\begin{abstract}
  \ABSTRACT{}
  
  \newcommand{\sep}{ \and }
  \keywords{Anonymity\sep{} blockchain\sep{} diagnosis\sep{} e-commerce\sep{} fair-exchange\sep{} privacy\sep{} services}
\end{abstract}

\section{Introduction}
\label{sec:introduction}
Diagnostic services such as paternity tests, doping tests or venereal disease tests are carried out in diagnostic centres that require customers to provide biological material such as blood, urine, stool or saliva. Unfortunately, customers are often forced to reveal their identity in order to complete transactions. Such a combination of personal information with biological materials exposes customers to significant privacy risks.

Other examples of sensitive services include anonymous complaints or legal services, such as legal advice, which may require disclosure of financial transaction history and confidential legal documents. Banking services, such as credit scoring, may require sensitive personal information, such as medical records and financial transaction history.

Providing personal information exposes users to a myriad of privacy risks, ranging from the potential loss of control over personal information to more severe threats like identity theft, data breaches, and unsanctioned monitoring. Such sensitive information is highly valuable to a potential attacker as it can be exploited for insider leaks, unauthorized entry, or financial profit. For instance, this data might be sold to marketers, banks, other corporations, government bodies, or cybercriminals. Consequently, this could unintentionally violate regulations like GDPR or CCPA, result in targeted advertising, or lead to crimes such as identity theft or unlawful tracking and surveillance~\cite{smithInformationPrivacyResearch2011}.

Public figures such as influencers, politicians or celebrities are particularly vulnerable to this type of attack, as exposure of their health records, purchasing habits or legal documents can threaten their reputation, position or be used for blackmail.

The problem is amplified when personal information is linked to health records, legal documents or biological materials such as DNA, saliva or blood. In such situations, customers may be reluctant to provide their personal information to the SP and therefore withdraw from the service.  \textbf{Both parties are harmed as the customer does not receive a diagnosis relevant to their health and the SP loses potential customers.}~\cite{klitzmanExclusionGeneticInformation2010,blackPresymptomaticTestingConfidentiality2021}

In the majority of healthcare system, the critical data managed typically resides in the Electronic Medical Records (EMRs), which is consistently regarded as confidential information requiring robust security measures~\cite{jinReviewSecurePrivacypreserving2019}~\cite{keshtaSecurityPrivacyElectronic2021}. 

Maintaining the privacy of health data seems to be open and active area of research in the field of Privacy-Preserving Data Mining (PPDM) ~\cite{nareshPrivacyPreservingData2023,linPPSFOpensourcePrivacypreserving2018,hewagePrivacypreservingDataStream2023}. The recent research in this area focuses on employing methods of anonymisation and hiding sensitive information of the EMRs~\cite{hamdiEnhancingSecurityPrivacy2023, sharmaPrivacyPreservingData2019, wuHidingSensitiveInformation2021}, or securing the interaction between patient and Healthcare system~\cite{zhangPrivacyProtectionTelecare2016, mehmoodAnonymousAuthenticationScheme2018, khasimImprovedFastSecure2022}.

Authors of~\cite{blackPresymptomaticTestingConfidentiality2021} highlight that after their organisation adopted Electronic Medical Record (EMR) systems, they could no longer promise the same confidentiality assurances.

Klitzman~\cite{klitzmanExclusionGeneticInformation2010} examined exclusion of genetic data from EMR, noting that patients frequently distrust healthcare facilities and choose not to share their genetic test results with doctors, fearing that this information might be recorded in their EMR.
 
In our study, we focus on the possibility of carrying out services without revealing any personal information — solving the problem of privacy at a much earlier stage, before any personal information gets into EMR system.

It would be desirable for customers to keep their identity private while still receiving the service. This could lead to a reduction in the trust that customers need to place in SPs and a reduction in the responsibility that SPs bear.

Examples of services that would benefit from the anonymity property are:
\begin{itemize}
    \item \textbf{Confidentiality in Medical Testing}: Patients who are willing to take a test, e.g. for drugs, STDs, paternity or steroids, have a strong incentive to keep the whole process private. The mere fact that they have taken the test—without revealing the result—is suggestive enough to be used as a premise in the event of a conflict.

    Currently, they have to take the risk that their personal data, materials and results will be stored securely and kept secret from any unauthorised actor (both curious employees and malicious attackers)~\cite{klitzmanExclusionGeneticInformation2010, blackPresymptomaticTestingConfidentiality2021}.


\item \textbf{Anonymity in Legal Consultations for Entrepreneurs}: Individuals engaged in entrepreneurial activities may want to assess the risks and possible consequences of their actions. By revealing their identity, they trust that the lawyer will not use this information for harmful actions.
\item \textbf{Whistleblowing Platforms}: Employees or citizens witnessing unethical or illegal activities within organizations can report these anonymously without fear of reprisal, job loss, or social stigma, thereby promoting a more transparent and accountable society.
\item \textbf{Sexual Health and Reproductive Services}: People seeking advice or services related to sexual health, contraception, or abortion might prefer anonymity due to the sensitive nature of these topics and potential societal judgment.
\end{itemize}

Using Solove's Taxonomy of Privacy~\cite{soloveTaxonomyPrivacy2006}, our protocol aims to prevent the following privacy risks: Breach of confidentiality, Disclosure, Identification, and Secondary use. We consider the following adversaries: Malicious insiders, Government agencies, Malicious third-party services, Hackers and cybercriminals.

In this work we explore the possibilities of anonymous service provision and propose a protocol that preserves the customer's privacy even in the event of a successful attack. Under realistic operational assumptions, we show that \textbf{decoupling personal information from materials, payment and communication achieves a sufficient level of anonymity}.

However, a protocol that hides the customer's identity is difficult to secure and coordinate. In particular, conflicts between customers and service providers are difficult to resolve when there is subject to accuse.

We observe that the problem of anonymous service provision can be seen as a problem of fair exchange, where parties exchange some goods fairly, i.e. either both parties obtain the goods, or they both obtain nothing.

In our case, the customer who wants to use the service exchanges his materials and money with the SP for the result of the service.

Our review shows that none of the current systems is sufficient to achieve the desired goal. We propose an anonymous protocol for the provision of services that require physical materials. In the event of a dispute, either due to missed deadlines or incorrect results, the customer can disclose the entire interaction, prove the SP's misbehaviour to the Dispute Resolution Service, and win the dispute.

To achieve this goal we use
\begin{itemize}
    \item \textbf{Blockchain}, to achieve fairness, i.e. as a means of proving that certain actions took place at a certain time without the Trusted Third Party (TTP).
    \item \textbf{Anonymous payment methods}, such as cash or anonymous cryptocurrencies, which allow customers to pay for services anonymously.
    \item \textbf{Decentralised storage network} (e.g. IPFS) to provide results together with a provable storage network (e.g. Filecoin) to guarantee that the results are available to the customer even if the SP refuses to share the result.
    
    \item Cryptography:
    \begin{itemize}
        \item \textbf{Symmetric encryption}, to encrypt and decrypt the results published on the public networks.
        \item \textbf{Diffie-Helman key exchange (DHKE)}, to derive shared secrets for symmetric encryption.
        \item \textbf{Digital signatures}, to achieve authentication and non-repudiation of actions. 
    \end{itemize}
    
\end{itemize}

Figure~\ref{fig:protocol-overview} shows a simplified diagram of the protocol.

\begin{figure}[h!]
\includegraphics[width=\linewidth]{protocol-overview.pdf}
\centering
\caption{A simplified diagram of the protocol. The first step involves the delivery of the materials to the SP. The second step involves anonymous payment. The third step involves the delivery of the result to the customer. Each step is proven on the message board, protecting the fair party in a conflict situation.}

\label{fig:protocol-overview}
\end{figure}

\paragraph{}
The contribution of our paper is:
\begin{itemize}
\item we propose a protocol that upon a realistic operational and threat model:
  \begin{itemize}
  \item allows \textbf{anonymous} service provision involving \textbf{physical materials}, i.e., the service provider does not need to collect any personal information from the customer;
  \item achieves \textbf{fairness} by the use of blockchain and cryptographic proofs. We model the protocol as an interactive non-cooperative game and show fairness at each of its steps.
  \item \textbf{does not rely on a centralised TTP}, but uses a decentralised blockchain and a distributed content-addressable storage network;
  \item in conflict-free transactions does not require customers to interact with the blockchain, achieving better \textbf{user experience and practicality};
  \item guarantees the \textbf{remote availability of the results}, even in case of the SP denial of service.
  \end{itemize} 
\item We implement a working prototype of the protocol and provide open source code.
\item We systematise often misused definitions of anonymity, pseudonymity, linkability and traceability.
\item We propose a framework for analysing fairness in fair exchange protocols and use it to prove the fairness of our protocol.
\item We discuss possible improvements to the protocol using secure computation, self-sovereign identities, zero-knowledge proofs, and blockchain-based dispute resolution techniques.
\end{itemize}

Some authors have proposed blockchain-based fair exchange systems that could be adapted to service provision; however, to the best of our knowledge, we are the first to propose a system that satisfies all of the above properties. In particular, anonymity and physical delivery have rarely been addressed together, and if so, the protocol was based on TTP and impractical assumptions about the banking system~\cite{birjoveanuAnonymityFairexchangeEcommerce2015} or did not address the conflict between parties~\cite{altawyLelantosBlockchainBasedAnonymous2017}.


The rest of this paper is organised as follows.
In Section~\ref{sec:related-works} we review related works. 
Then in Section~\ref{sec:building-blocks} we discuss the building blocks of a dispute resolution system, blockchain as a message board, fairness, anonymous payments, storage network, availability of results and anonymity.
Section~\ref{sec:protocol} provides a detailed description of the protocol.
Section~\ref{sec:fairness-analysis} provides a fairness analysis of the proposed protocol.
Section~\ref{sec:experiments} presents the implementation of the protocol and the results of our experiments.
Section~\ref{sec:discussion} discusses possible improvements in terms of crowdsourced dispute resolution or dispute avoidance, self-sovereign identities (SSIs), anonymous delivery, and formal verification.
Finally, Section~\ref{sec:conclusion} concludes the paper.


\section{Related Works}\label{sec:related-works}
This section reviews key protocols in fair exchange, anonymity, and physical delivery, highlighting their primary features and differences.

The most common application of fair exchange protocols
is e-commerce. A typical transaction involves a seller and
a buyer exchanging money for a physical product. To pro-
tect themselves, the seller wants to receive the funds before
sending the product, while the buyer wants to receive the
product before paying. The fairness of the protocol should
guarantee that either both parties obtain the goods, or they
both obtain nothing.
Early systems like the one by Zhang et al. (2006)\cite{zhangPracticalFairExchangeEPayment2006} and Mohammedalaraj (2012)\cite{mohammedalarajFairnessPhysicalProducts2012} introduced Trusted Third Parties (TTPs) and Delivery Agents (DAs) to ensure fairness, and relied on strong assumptions about non-collusion and resilient communication channels.

Protocols like those proposed by Bîrjoveanu et al. (2015-2022)~\cite{birjoveanuAnonymityFairexchangeEcommerce2015, birjoveanuPreservingAnonymityFair2018, birjoveanuAnonymityComplexTransactions2019, birjoveanuFairExchangeECommerce2020, birjoveanuTwoPartyECommerceProtocols2022} focus on anonymity in transactions involving physical products. These protocols utilize TTPs, anonymous communication channels like Tor, and cryptographic techniques like blind signatures to ensure privacy and fairness. However, they depend on the existence of TTPs and secure, confidential transaction systems between banks.

Blockchain technology offers solutions to the TTP dependency in fair exchange protocols. Hinarejos et al. (2019)\cite{hinarejosSolutionSecureCertified2019} demonstrated a blockchain-based protocol for certified email, replacing TTP with a decentralized, verifiable system. Themis (Meng et al., 2019)\cite{mengThemisDecentralizedEscrow2019} further advanced this by incorporating a decentralized dispute resolution mechanism, though it does not address anonymity.

Lelantos (Altawy et al., 2017)~\cite{altawyLelantosBlockchainBasedAnonymous2017} is a notable example of a blockchain-based system providing anonymous physical delivery. It uses onion routing and smart contracts to ensure anonymity, although it only achieves pseudonymity and lacks a dispute resolution mechanism.

\paragraph{Comparison and Our Approach}

We only considered protocols that achieve fair exchange, as this is the fundamental feature of such protocols.

We also didn't focus on protocols for buying digital products, as they are not relevant to our use case. A more comprehensive analysis of such protocols is available in~\cite{birjoveanuTwoPartyECommerceProtocols2022}.

Altawy et al. 2017~\cite{altawyLelantosBlockchainBasedAnonymous2017} is a blockchain-based protocol that provides anonymous physical delivery using onion routing and anonymous blockchain interaction, assuming unlinkability between pseudonyms and real identities. However, it does not provide dispute resolution.

Hinarejos et al. 2019~\cite{hinarejosSolutionSecureCertified2019} is the simplest protocol that replaces TTP with blockchain. However, it does not take into account anonymity, disputes between parties, or the exchange of physical material.

Meng et al. 2019~\cite{mengThemisDecentralizedEscrow2019} improves the previous protocol through the crowd-sourced dispute resolution system. However, it does not take anonymity into account.

Bîrjoveanu, 2022~\cite{birjoveanuTwoPartyECommerceProtocols2022} is the closest to our protocol, but it is based on strong assumptions, namely the existence of TTP, banks supporting confidential transactions with commit buffers, and maintaining a global list of coin serial numbers.

Our protocol differs from existing ones by focusing on anonymity and fair exchange without relying on TTPs or complex banking systems. It achieves anonymity by using either cash or privacy-preserving blockchains. In addition, our protocol does not require the customer to submit a transaction to the bulletin board simplifying the transaction process while maintaining anonymity and fairness.

Unlike most protocols, our system is designed for transactions where the package is delivered from the buyer to the Service Provider (SP), and we assume a generic Dispute Resolution Service for handling conflicts .

To provide a clearer understanding of how our protocol compares with existing work, Table~\ref{tab:comparision} presents a summary of key features and differences among the discussed protocols.


{\begin{table*}
\centering
\newcommand{\YES}{\cellcolor{green!50}Yes}
\newcommand{\YESBUT}{\cellcolor{green!25}Yes*}
\newcommand{\ID}{\cellcolor{green!25}Identity}
\newcommand{\PSEUDO}{\cellcolor{green!35}Pseudonym}
\newcommand{\ANON}{\cellcolor{green!50}Anonymity}
\newcommand{\NO}{\cellcolor{red!50}No}
\newcommand{\TTP}{\cellcolor{red!50}TTP}
\newcommand{\BC}{\cellcolor{green!50}BC}
\caption{Comparison of related works. The notation \textit{Pseudonymity} means that the anonymity is based on the assumption that the pseudonym is not linked to the real identity; \textit{TTP} means that the protocol uses a trusted third party; \textit{BC} means that the protocol uses a public blockchain; \textit{YES*} means that the protocol provides the feature but is based on strong or impractical assumptions.}
\label{tab:comparision}
\setlength{\tabcolsep}{3pt}

\begin{tabular}{cccccc}

\noalign{\smallskip}\hline\noalign{\smallskip}
Protocol & Fair exchange & Anonymity & Dispute resolution & Trust & Physical delivery \\
\noalign{\smallskip}\hline\noalign{\smallskip}
\cite{zhangPracticalFairExchangeEPayment2006} (2006) & \YES & \YESBUT & \YES & \TTP & \YES \\
\cite{mohammedalarajFairnessPhysicalProducts2012} (2012) & \YESBUT & \NO & \YES & \TTP & \YES \\
Lelantos~\cite{altawyLelantosBlockchainBasedAnonymous2017} (2017) & \YES & \PSEUDO & \NO & \BC & \YES \\
\cite{hinarejosSolutionSecureCertified2019} (2019) & \YES & \NO & \NO & \BC & \NO \\
Themis~\cite{mengThemisDecentralizedEscrow2019} (2019) & \YES & \NO & \YES & \BC & \NO \\
PPPDCP~\cite{birjoveanuTwoPartyECommerceProtocols2022} (2022) & \YES & \YES & \YES & \TTP & \YES \\
This paper & \YES & \YES & \YES & \BC & \YES \\
\noalign{\smallskip}\hline

\end{tabular}

\end{table*}
 
 
\section{Building Blocks}\label{sec:building-blocks}

\subsection{Physical products}\label{sec:physical-products}
The use cases discussed in this paper use physical materials such as blood, urine, hair and other biological materials.
This requirement, combined with the need for anonymity, is a challenging part of fair exchange protocols. The problem arises when the seller wants to send the product to the buyer who wants to remain anonymous. Most of the existing protocols either assume the existence of a trusted delivery agent~\cite{mohammedalarajFairnessPhysicalProducts2012,birjoveanuAnonymityFairexchangeEcommerce2015}, or use a complex delivery mechanism similar to onion routing involving multiple delivery services~\cite{altawyLelantosBlockchainBasedAnonymous2017}. 

However, our use case is different in that the physical materials are transferred from the (anonymous) customer to the (public) SP. This allows a simplification of the delivery process. We assume that there is a way to deliver a package anonymously without revealing the customer's personal information, either via the SP's drop box, parcel locker services (e.g. Amazon Locker, InPost), the customer's trusted Delivery Agent, or even the post office.

\subsection{Dispute resolution system}
\label{sec:dispute-resolution}
Disputes are an inevitable part of all human transactions. Whether intentional or accidental, the system should prevent violations of agreed contract rules or local jurisdiction. The rules are set by law and enforced by the police.

The vision of smart contracts was to replace the legal contract with
programmable and autonomous contracts. The code of the smart contract contains the specifications of the contract, hence the slogan \textit{code as law}. In addition, smart contracts are executed automatically, bridging the gap between law and its enforcement by police~\cite{allenGovernanceBlockchainDispute2019}. However, the blockchain paradigm has its limitations. 
 
Blockchains can only guarantee the correctness of the data and calculations that exist on the blockchain. The problem arises when we want the smart contract to make decisions based on some input from outside the blockchain. The technique for providing real-world data to the blockchain is called \textit{oracle}. An oracle provides data based on a decentralised network of mediators, so the trust is also decentralised~\cite{breidenbachChainlinkNextSteps2021}.

Some oracles provide data such as weather, football results, stock prices, train delays, election results and others-and these are the ones we are interested in-provide the resolution of a submitted dispute.

Themis~\cite{mengThemisDecentralizedEscrow2019} not only provides a fair exchange protocol, it also provides a semi-autonomous decentralised dispute resolution system that complies with the Web3 postulates of a decentralised Web~\cite{ethereumWhatWeb3Why2023}. Themis resolves disputes through a set of voluntary, anonymous mediators who take part in voting and decide whether a party has misbehaved. The honesty of the mediators is achieved through a monetary incentive and reputation system.

Kleros~\cite{bergollaKlerosSociolegalCase2022} is a smart contract deployed on the Ethereum platform that mimics, in a decentralised and autonomous way, how the court works in real life. In Kleros, every process of a dispute, such as gathering evidence, selecting jurors and rewarding the winning party, is automated by a set of smart contracts. As in Themis, the honesty of the agents voting in a case is achieved through game-theoretic economic incentives.

Such a decentralised, voluntary and anonymous dispute resolution system might work for simple breaches of contract, such as an eBay seller sending broken or wrong products, or an Airbnb apartment that does not match the photos in the listing. However, it is difficult to implement such a decentralised assessment of the quality of health or legal services when expertise and privacy concerns are taken into account. Therefore, our protocol takes a more conservative approach and resolves disputes by recording evidence on the blockchain and then using the local justice system (police or courts) to resolve the conflict.

Possible directions towards a semi-autonomous decentralised resolution system are discussed in Section~\ref{sec:decentralised-justice}.

\subsection{Fairness}\label{fairness}

In the event of a dispute, the customer can provide convincing evidence of the customer's honesty and the SP's misbehaviour to the judicial authorities (police or court). 
Because the customer is anonymous, the SP cannot start a dispute - there is no way to identify the customer.

To mitigate this problem, we have designed the protocol in such a way that the SP who follows the protocol is always in an advantageous position and therefore has no reason to start a dispute. On the other hand, the customer can start a dispute at any point in the protocol, but only the actual misbehaviour of the SP will lead to win the case.

Abstracting from the services provided by the SP, each party should be able to prove its honest behaviour in the event of a dispute. We propose three pieces of evidence that should be disclosed to the judiciary in the event of a dispute:

\begin{enumerate}
    \item \textbf{Proof of Delivery ($\textrm{PoD}$)} is a confirmation issued by the SP to the customer proving that the customer has delivered a complete (according to the SP's requirements) package to the SP and that the SP has accepted it. The formal definition of $\mathrm{PoD}$ is given in Section~\ref{proof-of-delivery}.
    
    \item \textbf{Payment $\textrm{receipt}$} is the confirmation that the customer has paid for the transaction at some point in time. The actual implementation depends on the cryptocurrency (or cash) and is discussed further in Section~\ref{payment-for-services}.
    
    \item \textbf{Proof of Provision ($\textrm{PoP}$)} is the proof that the SP has published the result at a given time. It protects the SP in the event the customer unjustifiably starts a dispute after the result has been published. The formal definition of $\mathrm{PoP}$ is given in Section~\ref{proof-of-provision}.
\end{enumerate}

\subsection{Message Board}\label{sec:message-board}
The term Proof of Provision ($\mathrm{PoP}$) that we have coined for the purposes of this protocol is often referred to as Proof of Existence~\cite{crespoStamperyBlockchainTimestamping2017}.

Its concept is to certify the existence, integrity and ownership of a particular information at a certain point in time (non-repudiation property).

We use this feature for two purposes: (1) to inform the customer about the existence of the results, with whom the SP cannot communicate via any other means, since the customer remains anonymous; (2) to allow the SP to prove the publication of the results within the deadline agreed with the customer.

By publishing the $\mathrm{PoP}$ on the blockchain, the SP cannot falsify the time at which the results were provided, as the block creation time proves it. The blockchain acts as a global clock that securely timestamps all data included in the block, so the $\mathrm{PoP}$ included in a block is associated with the time the block was created. Also, since the blockchain is public, anyone (including the judiciary) can be convinced that the service provider indeed released the result at that time.

Without such proof, there would be no other way to resolve the conflict between the customer claiming that the results were not published and the SP claiming that the results were published on time.

Depending on the context, the platform for achieving this is called bulletin board~\cite{achenbachImprovedCoercionresistantElectronic2015}, trusted timestamping~\cite{gippDecentralizedTrustedTimestamping2015}, or message board~\cite{hinarejosSolutionSecureCertified2019}. In this paper we call it a message board.

We keep the protocol general enough to be implemented using any existing technology to provide a message board service, provided it is decentralised and supports subscribing to upcoming proofs from a given address.

\subsection{Anonymity, pseudonomity, and confidentality}\label{sec:pseudo-anon}

Privacy is a concept used in almost all social sciences such as philosophy, psychology, sociology and law. This multidisciplinary nature leads to ambiguous definitions~\cite{smithInformationPrivacyResearch2011}. For our work we rely on more concrete definitions, i.e.~confidentiality and anonymity.

Confidentiality is the ability to hide the details of actions from others. Alternatively, we can say that the system guarantees confidentiality if, for all observers, all they can say about the action is the fact that it happened and nothing more.

Anonymity is the ability to hide one's identity from others. More specifically, it is the inability to correlate actions taken within the system with the identity of the user. Alternatively, we can say that the system guarantees anonymity if, for all observers, the actions are equally likely to be associated with any user of the system. However, anonymity is a spectrum rather than a dichotomous classification. One method of quantifying the level of anonymity is the \textit{k}-anonymity proposed in~\cite{sweeneyKanonymityModelProtecting2002}. It measures the user's anonymity by the number of other users from whom the user is indistinguishable. Specifically, the user is \textit{k}-anonymous if his actions are equally likely to be associated with \textit{k}-1 other users; the larger the \textit{k}, the greater the anonymity.

Some anonymity techniques can be used on non-anonymous blockchains. The so-called mixers gather users into an anonymity set who then collude to launder transactions in such a way that, to an observer, the likelihood of the sender of each transaction being any user from the anonymity set is equiprobable.

Some systems provide pseudonymity rather than anonymity. Pseudonymity allows users to hide their real identities behind pseudonyms. Although the whole system is transparent and allows actions to be linked to pseudonyms, the system is considered anonymous as long as the link between pseudonyms and real identities is secret. This assumption is difficult to meet in practice, as KYC (Know Your Customer) and AML (Anti Money Laundering) regulations require users to reveal their real identities to cryptocurrency exchanges, exposing users' privacy to government agencies, malicious insiders and cyber criminals. In addition, some correlations can be inferred simply by analysing transactions~\cite{androulakiEvaluatingUserPrivacy2013, oberStructureAnonymityBitcoin2013}.

Figure~\ref{fig:anonymity-diagram} illustrates the relationships between these terms.

\begin{figure}[h!]
\includegraphics[width=\linewidth]{anonymity-diagram.png}
\centering
\caption{Suppose Alice is the customer who wants to keep her identity anonymous and Bob is the public SP. Alice controls two addresses 1 and 2; the link between her real identity and the first address has been compromised and therefore identification is possible; the link to the second pseudonym is still unknown and therefore anonymous. Alice takes two actions, the first from the compromised address and the second from the anonymous address. The first action is confidential; therefore, even though the pseudonym has been compromised, the action cannot be associated with Alice. The second action is transparent, so Alice maintains her anonymity as long as the link to the second pseudonym is concealed.}

\label{fig:anonymity-diagram}
\end{figure}
The privacy-preserving blockchains are those that maintain anonymity through untraceability and (ideally) unlikability - not by assuming that the link between an address (pseudonym) and real identity is hidden.   

Examples of blockchains that natively support confidential transactions include Monero~\cite{vansaberhagenCryptoNote2013} (using Ring Signatures~\cite{noetherRingSignatureConfidential2015} or Bulletproofs~\cite{bunzBulletproofsShortProofs2018}), ZCash~\cite{ben-sassonZerocashDecentralizedAnonymous2014} (using zkSNARK~\cite{ben-sassonSNARKsVerifyingProgram2013}), Grin~\cite{fuchsbauerAggregateCashSystems2019} (using Mimblewimble~\cite{jedusorMIMBLEWIMBLE2016}), and IronFish~\cite{ironfishPrivateAnonymousEasy} (using Sapling protocol~\cite{hopwoodZcashSaplingProtocol2022}).

Overly techniques that achieve anonymity on top of non-privacy preserving blockchains are Ethereum's Tornado Cash~\cite{pertsevTornadoCashPrivacy2019} (via zkSNARK~\cite{grothSizePairingbasedNoninteractive2016} and MiMC~\cite{albrechtMiMCEfficientEncryption2016}), Bitcoin's Wasabi~\cite{wasabiwalletBitcoinPrivacyWallet} (via CoinJoin~\cite{maxwellCoinJoinBitcoinPrivacy2013}).

\subsection{Payment for services}\label{payment-for-services}
Transactions between customers and SPs need to be linked to prevent the reuse of a payment for multiple transactions. In other words, we need a mechanism that uniquely links the payment to the corresponding transaction.

Depending on the cryptocurrency, this link can be established in different ways:

\begin{itemize}
\item separate address: each transaction uses a unique address associated with the transaction. Such addresses can be derived using Hierarchical Deterministic Wallets~\cite{wuilleBIP32HierarchicalDeterministic2012} and published on the message board to achieve non-repudiation.
\item memo: payments are sent to a single SP account, but contain an extra field called ``memo'' filled with the unique identifier $\textrm{provisionID}$. 
\end{itemize}

Any payment that contains $\textrm{provisionID}$ in the memo or is sent to the designated address will be considered payment for the transaction. 

In the event of a dispute, there must be a way to prove to the courts that the customer has paid for the transaction. As proof of payment is trivial in transparent and traceable blockchains, it becomes more complicated when it comes to anonymous blockchains. Monero allows payments to be proven and verified via a dedicated API~\cite{moneroHowProvePayment}. ZCash provides a mechanism called Payment Disclosure~\cite{daviesIntroductionPaymentDisclosure2017}. We call the proof of payment a \textit{payment recepit}.

\subsection{Storage network}\label{storage-network}
Once the SP has completed its service, it needs to deliver the result to the customer. The most natural approach would be to send the result via email or a dedicated platform. However, the customer wants to remain anonymous and does not want to reveal his email address or IP address. Furthermore, the SP needs to prove that the result was delivered before the deadline, which brings us to the issue of proof of existence discussed in Section~\ref{sec:message-board}.

One approach would be to post the result to a blockchain. However, storing data on a blockchain is very expensive. The most common workaround (\cite{shahidBlockchainBasedAgriFoodSupply2020, wangAuditableProtocolsFair2019, chenImprovedP2PFile2017}) is to publish the data on a content addressable peer-to-peer storage network such as IPFS~\cite{benetIPFSContentAddressed2014}. Then publish only the content identifier ($\mathrm{cid}$) on the blockchain, which uniquely points to the content stored on IPFS.

We follow the same approach. Once the SP has produced the result, it encrypts it using the previously provided encryption key and uploads it to the IPFS network.

We also use Filecoin to guarantee that the results are available to the customer even if the SP refuses to share the result (see Section ~\ref{sec:provable-results-availability}).

To increase anonymity, the customer should use standard techniques to hide their IP address, such as VPN or proxy.

\subsection{Separation of concerns}
We could use a single blockchain to achieve all three of these roles: i) anonymous payments, ii) message board, and iii) storage network.

While most blockchains could provide message board functionality, anonymous payments are not as common. In particular, a verifiable storage network is a feature of a few specialised blockchains.

Rather than searching for a single blockchain to provide all functionalities, we allow the protocol to use separate blockchains for each role. If a suitable blockchain emerges, it can play more than one role.

At the time of writing, we see the following technologies fulfilling the requirements of each role:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}

\item Anonymous payments: Monero \cite{vansaberhagenCryptoNote2013}, ZCash
  \cite{ben-sassonZerocashDecentralizedAnonymous2014}, Grin \cite{fuchsbauerAggregateCashSystems2019},
  Tornado Cash \cite{pertsevTornadoCashPrivacy2019}.
\item Message board: Open timestamps~\cite{opentimestampsTimestampingProofStandard}, Stampery \cite{crespoStamperyBlockchainTimestamping2017}, Bitcoin blockchain (Proof of Existence~\cite{proofofexistenceWebApplicationProve}, Chainpoint~\cite{chainpointBlockchainProofAnchoring}), Ethereum blockchain, or any other public blockchain that supports attaching extra data along the transaction.
\item Storage network: IPFS~\cite{benetIPFSContentAddressed2014}, Filecoin~\cite{protocollabsFilecoinDecentralizedStorage2017}, or Ethereum's
  Swarm~\cite{teamSWARMStorageCommunication2021}.
\end{enumerate}

\section{The Protocol}\label{sec:protocol}
In this section, we propose an abstract protocol for anonymous service provisioning that makes no assumptions about the underlying technologies. We define the requirements for each role and leave the choice of technology to the developer. Later in the paper (Section~\ref{sec:experiments}) we describe our implementation, which we use to conduct an experiment.

\subsection{Assumptions}

\begin{itemize}
\item There exists PKI infrastructure:
    \begin{itemize}
        \item The customer and the SP have their key pairs consisting of secret key $\mathrm{sk}_\mathrm{party}$ and public key $\mathrm{pk}_\mathrm{party}$, where $\mathrm{party} \in \{\mathrm{C}, \mathrm{SP}\}$ for the customer and the SP accordingly.
        \item Both the customer and the SP can create and verify digital signatures created by the customer $\mathrm{sig}_{\mathrm{sk}_\mathrm{C}}$ and the SP $\mathrm{sig}_{\mathrm{sk}_\mathrm{SP}}$.
        \item The SP's public key $\mathrm{pk}_\mathrm{SP}$ is publicly known.
    \end{itemize}
    
\item Both the customer and the SP:
    \begin{itemize}
        \item use common symmetric encryption $\mathrm{E}_\mathrm{key}(\cdot)$ and decryption $\mathrm{D}_\mathrm{key}(\cdot)$ operations.
        \item have access to anonymous payments blockchain, message board, and storage network.
    \end{itemize}

\item The SP:
    \begin{itemize}
        \item accepts packages from unknown customers.
        \item accepts payments with cash and anonymous cryptocurrencies as described in Section~\ref{payment-for-services}.
    \end{itemize}
    
\item Dispute Resolution Service:
    \begin{itemize}
        \item accepts as evidence in a dispute the $\mathrm{PoD}$, $\mathrm{PoP}$, and payment $\mathrm{receipt}$ as described in Section~\ref{fairness}.
    \end{itemize}

\item Anonymous Payments Blockchain:
    \begin{itemize}
        \item supports anonymous, i.e., untraceable and (ideally) unlinkable transactions as described in Section~\ref{sec:pseudo-anon}.
        \item supports uniquely identifiable transactions via a dedicated address, memo field, or other similar mechanisms as described in Section ~\ref{payment-for-services}. 
    \end{itemize}

\item Message Board:
    \begin{itemize}
        \item supports transactions of sizes up to $\mathrm{PoD}$ and $\mathrm{PoP}$.
    \end{itemize}

\item Storage Network:
    \begin{itemize}
        \item allows content to be retrieved using a content identifier $\mathrm{cid}$ (usually a hash of the content).
        \item allows content to be retrieved anonymously.
        \item guarantees that the content will be available for the duration of the agreement.
    \end{itemize}
\end{itemize}

\subsection{Messages}\label{messages}
In this section, we describe the messages exchanged between the parties of the protocol.

\vspace{5mm}

\noindent \textbf
{Package}\label{package} is a physical container prepared by the customer encompassing all the $\mathrm{materials}$ required by the SP to provide the service.

$$\mathrm{pkg} \equiv (\mathrm{materials}, \mathrm{provisionID}, \mathrm{pk_C})$$

where:

\begin{itemize}

\item $\mathrm{materials}$ - are the materials required to provide the service, for example, samples of urine, blood, stool, saliva; legal documents, CDs, emails, photos, bank statements; or any other type of material depending on the service.
\item $\mathrm{provisionID}$ - a randomly generated provision identifier, used to anonymously track the provision through all steps of the protocol.
\item $\mathrm{pk_C}$ - the customer's public key used to encrypt the results published to the public storage network.
\end{itemize}

\noindent \textbf
{Proof of Delivery ($\mathrm{PoD}$)}\label{proof-of-delivery} is a confirmation that the customer has delivered a correct (according to the SP's requirements) package to the SP and that the SP has accepted it.

It is also an agreement between the customer and the SP, as it includes agreed-upon deadlines for actions and a method of payment.

The $\mathrm{PoD}$ is published on the message board by the SP. 

\begin{eqnarray}
\mathrm{PoD} & \equiv & (\begin{array}[t]{l}\mathrm{pk_C}, \mathrm{provisionID},  \mathrm{sig}_\mathrm{SP}, \mathrm{paymentAddress}, \\\\ 
\mathrm{T}_\mathrm{issue}, \mathrm{T}_\mathrm{pay}, \mathrm{T}_\mathrm{provide}\; )\end{array}
\end{eqnarray}

where:

\begin{itemize}
\item $\mathrm{pk_C}$ - the public key of the customer used to encrypt the result published on the public storage network.
\item $\mathrm{provisionID}$ - the number that uniquely identifies the transaction previously generated by the customer.
\item $\mathrm{sig}_\mathrm{SP}$ - the SP's signature to ensure non-repudiation.
\item $\mathrm{paymentAddress}$ - payment address of the SP's anonymous blockchain account.
\item $\mathrm{T}_\mathrm{issue}$ - time at which the $\mathrm{PoD}$ is issued by the SP.
\item
  $\mathrm{T}_\mathrm{pay}$ - deadline for paying the transaction.
\item
  $\mathrm{T}_\mathrm{provide}$ - deadline to provide the result of the service, i.e. to publish $\mathrm{PoP}$.
\end{itemize}

also:
\(\mathrm{T}_\mathrm{issue} \leq \mathrm{T}_\mathrm{pay} \leq \mathrm{T}_\mathrm{provide}\)


\noindent \textbf
{Proof of provision ($\mathrm{PoP}$)}\label{proof-of-provision} is proof that the SP published the result at a certain time. It protects the SP in case the customer unjustifiably starts a dispute after the results have been published. The link between $\mathrm{PoP}$ and the results is made by the content identifier ($\mathrm{cid}$), which uniquely identifies the results so that the result cannot be forged after the $\mathrm{PoP}$ has been published.

The $\mathrm{PoP}$ is published on the message board by the SP.


\begin{eqnarray}
\mathrm{PoP} & \equiv & (\mathrm{cid}, \mathrm{provisionID}, \mathrm{sig}_\mathrm{SP})
\end{eqnarray}

where:

\begin{itemize}

\item $\mathrm{cid}$ - the content identifier as specified in Section~\ref{storage-network}.
\item $\mathrm{provisionID}$ - The number that uniquely identifies the transaction previously created by the customer.
\item $\mathrm{sig}_\mathrm{SP}$ - the signature of the SP, which guarantees non-repudiation.
\end{itemize}

\noindent \textbf
{Payment-receipt}\label{payment-receipt} proves that the customer made the payment. Since the proof depends on a specific blockchain (see Section~\ref{payment-for-services}), we symbolically refer to it as $\mathrm{receipt}$.

\noindent \textbf
{Results}\label{results} is assumed to be a document in PDF format, but any other format is acceptable as long as it can be binary encoded and uploaded to the storage network. We symbolically refer to it as $\mathrm{results}$.

\noindent \textbf
{Content Identifier (cid)}\label{content-identifier-cid} is a term coined by IPFS~\cite{ipfsContentIdentifiersCIDs}. However, since our protocol does not depend on this particular implementation of the storage network, we let the $\mathrm{cid}$ be any other identifier that securely and uniquely points to the content.

\subsection{Protocol description}\label{protocol-description}

In this section we describe each step of the protocol, also shown in Figure~\ref{fig:protocol-diagram}.

\begin{figure}[ht!]
\includegraphics[width=\linewidth]{anonser-protocol.png}
\centering
\caption{Messages exchanged in the protocol. Solid arrows indicate requests and dashed arrows indicate responses.}
\label{fig:protocol-diagram}
\end{figure}

\noindent \textbf
{Step 0.  Preparation}\label{step-0-preparation}

The customer collects all $\mathrm{materials}$ required by the SP, generates a random $\mathrm{provisionID}$ and a random keypair $(\mathrm{sk_C},\mathrm{pk_C})$. The $\mathrm{provisionID}$ is used to connect all actions associated with the transaction throughout the protocol. The $\mathrm{provisionID}$ and $\mathrm{pk_C}$ are encoded as a QR code, printed and attached to the $\mathrm{pkg}$ package. The $\mathrm{sk_C}$ is kept secret and is used to decrypt the $\mathrm{result}$ at the end of the protocol.

\noindent \textbf
{Step 1. Package Delivery}\label{step-1-package-delivery}

The protocol starts when the customer delivers the package $\mathrm{pkg}$ to the SP and its content is accepted. As a result, $\mathrm{PoD}$ is created with a predefined payment deadline $\mathrm{T}_\mathrm{pay}$, service provision deadline $\mathrm{T}_\mathrm{provide}$ and current time $\mathrm{T}_\mathrm{issue}$. In addition, $\mathrm{PoD}$ embodies information on whether the service was paid for in cash or whether the customer should pay using the anonymous blockchain account. In the latter case, the SP's payment $\mathrm{address}$ is included in $\mathrm{PoD}$.

The digital signature $\mathrm{sig}_{\mathrm{sk}_\mathrm{SP}}$ on the $\mathrm{PoD}$, created with the SP's secret key $\mathrm{sk}_\mathrm{SP}$, guarantees non-repudiation.

Symbolically: 
\[
\mathrm{PoD \gets delivery(pkg)}
\]

\noindent \textbf
{Step 2. Proof of Delivery}\label{step-2-pod}

Then, the $\mathrm{PoD}$ is published on the message board by the SP, committing to the fact that the package $\mathrm{pkg}$ has been delivered, and the SP cannot reject receiving it. If the provision has not been paid in cash, the SP waits for the customer to pay for the service at the payment $\mathrm{address}$ specified in the $\mathrm{PoD}$.

Symbolically: 
\[
\mathrm{publish(PoD)}
\]

The Algorithm~\ref{alg:proofOfDelivery} presents the process of processing the PoD and recording it on-chain.

\begin{algorithm}
\caption{Algorithm for Registering Proof of Delivery}
\label{alg:proofOfDelivery}
\begin{algorithmic}[1]
\Function{proofOfDelivery}{$pk_C$, $provisionId$, $sig_{SP}$, $paidInCash$, $paymentAddress$, $paymentWindow$, $provisionWindow$}
    \State Verify $sig_{SP}$
    \If{provisions[$pk_C$][$provisionId$].exist}
        \State \Return Error("Provision already exists")
    \EndIf

    \If{$paidInCash = \text{TRUE} \oplus paymentAddress$ is not empty}
        \State \Return Error("Pay in cash or specify paymentAddress")
    \EndIf
    
    \State $\mathrm{T}_\mathrm{issue} \gets$ block.timestamp
    \State $\mathrm{T}_\mathrm{pay} \gets \mathrm{T}_\mathrm{issue} + paymentWindow$
    \State $\mathrm{T}_\mathrm{provide} \gets \mathrm{T}_\mathrm{issue} + provisionWindow$

    \State $provision \gets \left\{ \mathrm{T}_\mathrm{issue}, paymentDeadlineTime, \right.$
    \State \hspace{\algorithmicindent}$\left. \mathrm{T}_\mathrm{pay}, \mathrm{T}_\mathrm{provide}, paidInCash, paymentAddress \right\}$
    \State provisions[$pk_C$][$provisionId$] $\gets provision$
\EndFunction
\end{algorithmic}
\end{algorithm}


\noindent \textbf
{Step 3. Get Proof of Delivery}\label{step-3-get-pod}

Once the package has been delivered and the $\mathrm{PoD}$ has been published, the customer can retrieve the $\mathrm{PoD}$ from the message board and (if everything is correct) proceed with the protocol.

Symbolically: 
\[
\mathrm{PoD \gets get(pk_C, provisionID)}
\]

\noindent \textbf
{Step 4. Payment}\label{step-4-payment}

If the provision was not paid in cash, the customer should pay for the transaction using the predefined anonymous payment blockchain (see Section~\ref{payment-for-services}).
In return, the customer receives the $\mathrm{receipt}$, which should be disclosed in case of dispute.

Symbolically: 
\[
\mathrm{receipt \gets payment(paymentAddress)}
\]

\noindent \textbf
{Step 5. Provision of Service}\label{step-5-provision-of-service} 

Once the customer has paid for the transaction, either in cash or via the anonymous blockchain, the SP can begin to provide the service.

Symbolically: 
\[
\mathrm{result \gets provision(materials)}
\]

\noindent \textbf
{Step 6. Upload result}\label{step-6-upload-result}

When the service is complete, a result should be generated. 
Next, the result is encrypted using a shared key derived from the customer's public key $\mathrm{pk_C}$ and the SP's secret key $\mathrm{sk(SP)}$ using the Diffie-Hellman key exchange (DHKE) method~\cite{diffieNewDirectionsCryptography1976}.
The encrypted result is then uploaded to the content addressable network (such as IPFS). In return, the content identifier ($\mathrm{cid}$) is created.

Symbolically: 
\[
\mathrm{cid \gets upload(E_{DHKE(sk_{SP}, pk_C)}(result))}
\]

\noindent \textbf
{Step 7. Proof of Provision}\label{step-7-proof-of-provision}

When the $\mathrm{result}$ is uploaded, the SP creates and publishes on a message board a proof of provision consisting of $\mathrm{cid}$ along with $\mathrm{provisionID}$ and signature $\mathrm{sig}_\mathrm{SP}$.

Symbolically: 
\[
\mathrm{publish(PoP)}
\]

The Algorithm~\ref{alg:proofOfProvision} presents the process of processing the PoP and recording it on-chain.

\begin{algorithm}
\caption{Algorithm for Registering Proof of Provision}
\label{alg:proofOfProvision}
\begin{algorithmic}[1]
\Function{proofOfProvision}{$pk_C$, $provisionId$, $cid$}
    \State $provision \gets$ provisions[$pk_C$][$provisionId$]
    \If{not $provision$.exist}
        \State \Return Error("Provision must be created with proof of delivery first")
    \EndIf
    \State Update $provision$ with $\{cid\}$
    \State provisions[$pk_C$][$provisionId$] $\gets$ $provision$
\EndFunction
\end{algorithmic}
\end{algorithm}

\noindent \textbf
{Step 8. Get Proof of Provision}\label{step-8-get-proof-of-provision}

After delivering the package and paying for the transaction, the customer starts listening to the message board and waits until the SP publishes the $\mathrm{PoP}$ for the $\mathrm{provisionID}$.

Symbolically: 
\[
\mathrm{cid \gets get(pk_C, provisionID)}
\]

\noindent \textbf
{Step 9. Download result}\label{step-9-download-result}

Having the $\mathrm{cid}$, the customer downloads and decrypts the $\mathrm{result}$ using a shared key derived from the customer's secret key $\mathrm{sk_C}$ and the SP's public key $\mathrm{pk_{SP}}$ using the DHKE method. The protocol ends.

Symbolically: 
\[
\mathrm{result \gets D_{DHKE(sk_C, pk_{SP})}(download(cid))}
\]

\section{Fairness analysis}\label{sec:fairness-analysis}
We analyse the fairness of the protocol by representing it as an interactive non-cooperative game.

\subsection{Model}\label{sec:fairness-model}
We consider three positions:

\begin{itemize}
\item \textbf{Neutral position ($\neutral{}$)}: when a party has neither spent nor gained anything of significant value (money, time, effort). For example, at the beginning of the protocol.
\item \textbf{Disadvantaged position ($\minus{}$)}: when a party has put a significant value without receiving an equivalent. For example, the customer has paid in advance for a service.
\item \textbf{Advantaged position ($\plus{}$)}: when a party would benefit if the transaction was stopped at this step. For example, the SP has received payment before the service has been provided.
\end{itemize}

There are many actions that each party can take, but we group them into two categories:


\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}

\item \textbf{Normal}: taking actions prescribed by the protocol.
\item \textbf{Abnormal}: anything that deviates from the intended steps of the protocol. For example, sending an arbitrary message, skipping or repeating steps, or timing out.
\end{enumerate}

In addition, at each step of the protocol, the customer can start a dispute, so another dimension with two positions must be taken into account:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}

\item \textbf{Agree}: the customer agrees with the action and therefore does not start a dispute.
\item \textbf{Start a dispute}: the customer disagrees with the action and therefore starts a dispute.
\end{enumerate}

As a result, in our analysis we need to consider four different outcomes for each party of the protocol ($\mathrm{party \in \{C, SP}\}$), for each step of the protocol ($\mathrm{step \in 1..9}$):

\begin{itemize}

\item
  $\mathrm{\sigma_{step,party,n}}$: after following the protocol when the other party acted normally.
\item
  $\mathrm{\sigma_{step,party,d}}$: after a settled dispute when the other party acted normally.
\item
  $\mathrm{\sigma_{step,party,\overline{n}}}$: after not starting a dispute despite the other party has acted abnormally.
\item
  $\mathrm{\sigma_{step,party,\overline{d}}}$: after a settled dispute when the other party has acted abnormally.
\end{itemize}



The protocol terminates after the last step, after starting a dispute, or after a party fails to complete its designated action in time. Therefore, all positions except $\mathrm{\sigma_n}$ are termination positions.

Because the customer is anonymous, the SP cannot start a dispute - there is no way to identify the customer. To mitigate this problem, we designed the protocol so that the SP who follows the protocol is always in an advantageous position and therefore has no reason to start a dispute. On the other hand, the customer can start a dispute at any time during the protocol, but only the actual misbehaviour of the SP will make him win the conflict.

\begin{definition}[Fairness] \label{def:fairness}
A protocol achieves fairness iff 
\begin{equation*}
\begin{split}
\forall_{party \in parties}\forall_{\mathrm{step} \in \mathrm{steps}} &\operatorname{can\ move}\\
&\operatorname{to the\ non-disadvantaged\ position} 
\end{split}
\end{equation*}

\end{definition}


\subsection{Assumptions}\label{sec:assumptions}

Below we list the assumptions we take for the analysis purpose.  

\begin{enumerate}
\item Both parties start from a neutral position ($\neutral${}).
\item After completing a transaction, both parties end up in an advantageous position (\plus{}). In other words, they have an intrinsic motivation to initialise and complete the transaction.
\item The protocol steps are atomic - there are no intermediate steps.
\item The protocol can only go forward - there is no way to undo any action.
\item Repeating the first step starts a new transaction. Repeating any other step is considered abnormal and is ignored. For example, paying the invoice twice has no effect on the curse of the protocol.
\item Once published, the result is available to the customer on the storage network. 
\item Winning the dispute results in a neutral position ($\neutral${}).
\item Losing the dispute results in a penalty greater than any reward, leading to a disadvantaged position (\minus{}). Therefore, the rational customer will not start a dispute that he is not sure he can win.
\item Both the customer and the SP are rational. They always prefer to go from the worst position (\minus{} or $\neutral${}) to a better position ($\neutral${} or \plus), but they are willing to risk a temporary worst position in favour of a later better position if and only if they can always get out of the worst position; in particular, the customer can always start a dispute and, if the SP has misbehaved, get out of the disadvantaged position (\minus) to the neutral position ($\neutral${}).
\item We assume that the customer's materials without personal information are useless and the effort to deliver the package is negligible, so the customer's first step does not lead to a disadvantaged position.
\item We assume that the processing cost of publishing $\mathrm{PoD}$ is negligible and compensates for the customer's effort in delivering the package.
\end{enumerate}

\subsection{Steps}\label{sec:steps}

Figure~\ref{fig:positions} shows the positions of each party after each possible action taken.

\begin{figure}[h!]
\includegraphics[width=\linewidth]{model.png}
\centering
\caption{Visual representation of the fairness of the protocol. The figure shows the game-theoretic outcomes of each party after each possible actions taken. Symbol $\neutral${} represents neutral outcome, \minus{} represents disadvantaged outcome, and \plus{} represents advantaged outcome, where the order relation holds \minus{} < $\neutral${} < \plus{}.}
\label{fig:positions}
\end{figure}

The detailed description of each step and the rationale for the outcome is given in Appendix~\ref{app:proof-of-fairness}.

\subsection{Example scenarios}\label{example-scenarios}
The Figure~\ref{fig:misbehaviour} shows the transitions of positions when the SP tries to misbehave and does not perform the service and therefore does not publish $\mathrm{PoP}$ after receiving the payment. After the deadline $\mathrm{T}_\mathrm{provide}$ the SP cannot publish valid $\mathrm{PoP}$ and so the customer starts a dispute. The customer wins the dispute because the SP cannot prove that the $\mathrm{PoP}$ was published before $\mathrm{T}_\mathrm{provide}$. The protocol ends up neutral for the customer and disadvantageous for the SP's positions.

\begin{figure}[h!]
\includegraphics[width=\linewidth]{misbehaviour.png}
\centering
\caption{Transitions of positions where the SP is misbehaving and the customer starts a dispute.}
\label{fig:misbehaviour}
\end{figure}

The rational course for both parties is to follow the protocol shown in Figure~\ref{fig:rational}.

\begin{figure}[h!]
\includegraphics[width=\linewidth]{rational.png}
\centering
\caption{Transitions of positions where both the customer and the SP follow the protocol.}
\label{fig:rational}
\end{figure}

Using the definition of fairness~\ref{def:fairness} and the assumptions listed in Section~\ref{sec:assumptions}, our analysis shows that the protocol achieves fairness.

\section{Experiments}\label{sec:experiments}

\subsection*{Setup}

We have developed a prototype of our protocol using the following technologies:

\begin{itemize}
  \item{Anonymous Payments} - we use the Monero blockchain \cite{noetherRingSignatureConfidential2015}.
  \item{Storage Network} - we use the Powergate~\cite{textilePowergate2023}, which is a wrapper around Filecoin and IPFS.
  \item{Message Board} - we use the Ethereum blockchain~\cite{woodEthereumSecureDecentralised2014}; specifically, its local development version Truffle Ganache and the Solidity language.
\item{Customer and SP} - we create client-side web application (webapp) using \texttt{React.js} and \texttt{web3.js} library for interaction with Ethereum. We use \texttt{MetaMask} browser extension to sign and submit transactions to the Ethereum node. We use \texttt{monerod} network client and \texttt{monero-wallet-cli} command line interface to interact with the Monero blockchain.
\end{itemize}

The prototype is available at \url{https://anonser.stan.bar}. The source code is available at \url{https://github.com/stanbar/anonser}.

% The prototype is available at \url{https://anonser.stan.bar}. The source code is available at \url{https://github.com/stanbar/anonymous-provision-of-services-via-blockchain}.

We developed and tested our prototype in the following environment: OS — Arch Linux 5.11.8; Docker — 20.10.5; CPU — Intel(R) Core(TM) i7-4790 (8) 4.00~GHz; RAM — 16 GB DDR3; Storage — Samsung PM85 256~GB SSD; monerod and monero-wallet-cli — v0.18.1.2; Powergate — v2.6.2; Ganache — v7.5.0; Solidity — v0.8.17; ReactJS — v18.0.25; web3.js — v1.8.1; crypto-js — v4.1.1.

For simplicity, all components run on one, mentioned above, physical machine; and all processes are managed by Docker. 

Moreover, Powergate is configured to use local Filecoin and IPFS networks.
For the Ethereum blockchain, we use Truffle Ganache, which is a local Ethereum blockchain for development and testing purposes. 
Monero is configured to use the public stage network.
We assume that the service provider offers only one type of service at a fixed public price, so we omit the service type and price from the protocol.

\subsection*{Preparation}

Both the customer and the SP create Monero wallets using the \texttt{monero-wallet-cli} command line tool.

The SP deploys the smart contract using the \texttt{truffle migrate --network development} command, which deploys the smart contract to the Ethereum blockchain. The web application is configured to use the last deployed smart contract address.

The customer receives some test Monero funds using the Faucet service available at \url{https://community.rino.io/faucet/stagenet/}.

Next, the customer enables per-transaction proof generation (payment \texttt{receipt}) by setting \texttt{set store-tx-info 1} for their wallet. This is required to verify the payment in the event of a dispute.

At this point both the customer and the SP are ready to start the protocol.

\subsection*{Experiment}

The customer and the SP are two different users of our prototype, but for simplicity, they use the same machine and the same web application.

The experiment was conducted as follows:

\begin{enumerate}
  \setcounter{enumi}{0}
  \item[0.] The protocol starts with the customer opening the webapp and creating a new provision.
The application generates a random ECDSA (secp256k1) customer keypair and a random 32-byte provisionID, and then displays a QR code that encodes both the provisionID and the customer's public key. 
The customer's private key must be downloaded and provided later to decrypt the results.

  \item[1.] The customer prints the QR code, sticks it on a parcel and delivers the parcel to the SP either via the SP's drop box, parcel locker services (e.g. Amazon Locker, InPost~\cite{inpostParcelLockerService}), the customer's trusted delivery agent or the post office.

  \item[2.1.] The SP opens the app and scans the QR code, which decodes the provisionID and the customer's public key.

  \item[2.2.] Since (in this experiment) the provision was not paid in cash, the SP generates a unique Monero payment address using \texttt{monero-wallet-cli integrated\_address}. 
  \item[2.3.] The SP submits the Proof of Delivery to the Ethereum blockchain using the MetaMask interface. 

  % monero-wallet-cli --stagenet --wallet-file sp --password "" integrated_address
  % Random payment ID: <2b6d65d7d48b7896>
  % Matching integrated address: 5LHmrsVsQM2Q2TgqufX4A5gKPpxy1czHULDyVc84omvnh1nQLVmqXk4VBuy8WnX1AXfKxDx7xuASAc6svkZqGVkL1XkUBWT7QejHymEaYM
  \item[3.] The customer (using the webapp) checks the transaction status on the Ethereum blockchain by calling \texttt{getProvision} with arguments \texttt{customerPubKey} and \texttt{provisionID}.
  % monero-wallet-cli --stagenet --wallet-file customer --password "" transfer 5LHmrsVsQM2Q2TgqufX4A5gKPpxy1czHULDyVc84omvnh1nQLVmqXk4VBuy8WnX1AXfKxDx7xuASAc6svkZqGVkL1XkUBWT7QejHymEaYM 1
  % Transaction successfully submitted, transaction <7d89c04de458cfb76a811d5eb325075dec59f7a993c3bf7ce37f9e3a1630af65>
  % monero-wallet-cli --stagenet --wallet-file customer --password "" get_tx_key 7d89c04de458cfb76a811d5eb325075dec59f7a993c3bf7ce37f9e3a1630af65
  % Tx key: 1364dc848a752bf52011f4a63d98bcb16091cacd985713b6b5264b3ede6de40f

  \item[4.] The customer sends the payment (using \texttt{monero-wallet-cli transfer}) to the \texttt{paymentAddress} specified in the smart contract and stores the payment receipt (using \texttt{monero-wallet-cli get\_tex\_key <tx-id>}) in case of a dispute.
  \item[5.] Once the SP notices the payment on the Monero blockchain, it starts providing the service and outputs the file \texttt{result.pdf}.

  \item[6.] The SP uploads the file \texttt{result.pdf} to the IPFS and Filecoin networks using Powergate. As a result, the SP receives the content identifier \texttt{cid}, as well as \texttt{dealID} and \texttt{minerID}.

  \item[7.] The SP submits a Proof of Provision transaction to the Ethereum blockchain by calling \texttt{proofOfProvision} with arguments \texttt{customer\-PubKey}, \texttt{provisionID}, \texttt{cid} and \texttt{dealID}.

  \item[8.] Meanwhile, the customer subscribes to Ethereum and waits for the SP to publish the Proof of Provision.
 Once the Proof Of Provision is published, the customer downloads the result using either the IPFS network using \url{https://dweb.link/<cid>} or Lotus network using \texttt{lotus retrieve <cid> <minerID>}. 
 
  \item[9.] The results are then decrypted using the customer's previously stored private key. If everything is correct, the customer is satisfied with the service and the protocol ends, otherwise the customer can initiate a dispute.

\end{enumerate}

\subsection{Results}

\paragraph{Fairness}
Fairness within the protocol was demonstrated, as detailed in Section~\ref{sec:steps} and ~\ref{app:proof-of-fairness}. This was achieved through an undeniable handshake mechanism, where the SP first commits to the package delivery and service deadlines by publishing the PoD (as outlined in step 2). The customer then acknowledges this commitment and accepts the terms by proceeding with the payment for the service (step 3).

Once payment is confirmed, the SP is incentivized to fulfill the service obligations. The SP must deliver the service and publish both the results and the PoP before the agreed deadline (step 7). Failure to do so allows the customer, equipped with all necessary evidence, to initiate a dispute and potentially penalize the SP. This mechanism ensures that rational parties are motivated to adhere to the protocol.

The protocol also ensures non-repudiation without the need for a TTP by employing blockchain technology and digital signatures. The blockchain provides a transparent and immutable record, ensuring that any changes to the smart contract's state are publicly visible and can only be made by the SP.


\paragraph{Anonymity}
Anonymity was achieved through the decoupling of personal information from transactional elements such as materials, payment, and communication. Anonymous payment methods were employed, including cash and privacy-focused cryptocurrencies like Monero, which obscure the details of transactions. Decentralized storage networks, namely IPFS and Filecoin, were also utilized to enhance privacy. These networks enabled the storage and retrieval of information without the need to disclose the customer's identity, ensuring that customers could engage with the protocol anonymously at every stage.


\paragraph{Provable Results Availability}\label{sec:provable-results-availability}
The availability of the result is guaranteed by the usage of Filecoin~\cite{protocollabsFilecoinDecentralizedStorage2017}, which operates as an incentivization layer on top of IPFS. Filecoin enhances content availability by economically penalizing the lack of proof of content storage~\cite{filecoinSlashing}.

In our protocol, the SP is responsible for uploading the result to both the IPFS and Filecoin networks (utilizing Powergate), which ensures free access to the results under normal operational circumstances. This dual-network approach also ensures high availability of the results, even if the SP ceases to host the content on their node.

\paragraph{Costs}
The deployment and operation of smart contracts on the Ethereum blockchain incur gas fees, which are proportional to the computational resources required for transaction execution. The following outlines the gas consumption and associated costs for each operation within our protocol, based on the testnet metrics which are analogous to the mainnet:

\begin{itemize}
    \item \textbf{Smart Contract Deployment}: Consumed 1,456,577 gas units.
    \item \textbf{Proof of Delivery}: Consumed 129,649 gas units.
    \item \textbf{Proof of Provision}: Consumed 149,130 gas units.
\end{itemize}

The cost of gas is denominated in ETH, and the price per unit of gas at the time of the experiment (January 3, 2023) was 0.000000002227 ETH/gas, with the ETH price being \$1,261.97 USD\footnote{Etherscan Gas Tracker, \url{https://etherscan.io/gastracker}}.
The customer is responsible only for covering the payment transaction fee. For transactions using Monero, the fee was approximately 0.000304 XMR at the time of the experiment, with the price of Monero being \$150 USD per XMR\footnote{Cryptocurrency statistics, \url{https://bitinfocharts.com}}.

The incurred costs were as follows:

\begin{itemize}
    \item \textbf{Deploying the Smart Contract}: \( 0.000000002227 \frac{\text{ETH}}{\text{gas}} \times 1,456,577 \, \text{gas} \times 1,261.97 \frac{\text{USD}}{\text{ETH}} \approx 4.09 \, \text{USD} \). This is a one-time cost, paid by the SP.

    \item \textbf{Proof of Delivery}: \( 0.000000002227 \frac{\text{ETH}}{\text{gas}} \times 129,649 \, \text{gas} \times 1,261.97 \frac{\text{USD}}{\text{ETH}} \approx 0.29 \, \text{USD} \). This fee is paid once per transaction, paid by the SP.

    \item \textbf{Payment}: \( 0.000304 \, \text{XMR} \times 150 \frac{\text{USD}}{\text{XMR}} \approx 0.0456 \, \text{USD} \).  This fee is paid once per transaction, paid by the customer.
        
    \item \textbf{Proof of Provision}: \( 0.000000002227 \frac{\text{ETH}}{\text{gas}} \times 149,130 \, \text{gas} \times 1,261.97 \frac{\text{USD}}{\text{ETH}} \approx 0.33 \, \text{USD} \). This fee is paid once per transaction, paid by the SP.
\end{itemize}

Additionally, our protocol's interaction with the Filecoin network introduces costs in FIL cryptocurrency for data storage and retrieval. These costs are determined through market-driven deals with miners. Deal prices, quoted in FIL, are influenced by various factors including data size, storage duration, and miner policies. The dynamic nature of these parameters means that costs can fluctuate, making precise predictions challenging. However, for our experiment, we leveraged Filecoin's reputation-based incentivisation layer to publish deals at no cost\footnote{Filecoin, Filecoin Plus Overview, \url{https://docs.filecoin.io/store/filecoin-plus/overview/}, (last visited Jan. 04, 2023)}.

\paragraph{Performance Evaluation Metrics}

To provide a comprehensive performance evaluation of our protocol, we have analyzed the following metrics for each of the blockchain networks:

\begin{itemize}
    \item \textbf{Ethereum Network}:
    \begin{itemize}
        \item \textbf{Block Time}: Approximately 13-15 seconds.
        \item \textbf{Transaction Throughput}: Ranges between 15-30 transactions per second (TPS).
        \item \textbf{Transaction Latency}: Approximately 6 minutes.
    \end{itemize}
    
    \item \textbf{Monero Network}:
    \begin{itemize}
        \item \textbf{Block Time}: Approximately 2 minutes.
        \item \textbf{Transaction Throughput}: Approximately 4 TPS.
        \item \textbf{Transaction Latency}: Approximately under 20 minutes.
    \end{itemize}
    
    \item \textbf{Filecoin Network}:
    \begin{itemize}
        \item \textbf{Block Time}: Approximately 30 seconds.
        \item \textbf{Transaction Throughput}: Not explicitly stated. The network is optimized for storage operations rather than transaction processing, with the throughput being primarily dependent on the storage and retrieval deal proposals.
        \item \textbf{Transaction Latency}: Storage deal transactions take approximately 5-10 minutes for a 1 MiB file.
    \end{itemize}
\end{itemize}

These metrics are crucial for understanding the scalability and efficiency of the blockchain networks in question and provide insight into their suitability for various applications within our protocol.

\section{Discussion}
\label{sec:discussion}

\subsection{Dispute Resolution Service}\label{sec:decentralised-justice}
Centralised Dispute Resolution Service is the biggest obstacle to the realisation of a system that is compliant with the Web3 postulates~\cite{ethereumWhatWeb3Why2023}.

Possible directions for mitigating such problems are either (i) replacing local justice with blockchain dispute resolution systems, such as those proposed in Themis~\cite{mengThemisDecentralizedEscrow2019}, Kleros~\cite{bergollaKlerosSociolegalCase2022, gudkovCrowdArbitrationBlockchain2020}, Aragon Court~\cite{aragonDecentralizedDisputeResolution}, LTO Network~\cite{ltonetworkNextGenBlockchainB2B}, and other Online Dispute Resolution platforms~\cite{allenGovernanceBlockchainDispute2019}; or (ii) make it infeasible to provide incorrect results.

The first approach is more feasible in the near future. It would require the creation of a large set of experts in a field who, in the case of a dispute, would receive all the proofs ($\mathrm{PoD}$, $\mathrm{PoP}$, payment $\mathrm{receipt}$ as well as any other proofs relevant to the case) that could be queried by the experts in a zero-knowledge fashion, i.e. they could ask a limited number of questions of the proofs and get yes/no answers. The case would be completely confidential as they would not be able to query any personal information. Experts would be incentivised to participate in the pool by the fee system. They would be incentivised to vote honestly by the stake they would have to lock and the reward/punishment they would receive for a correct/incorrect judgement, correctness being determined by the quorum of votes.

The second is more futuristic. Let us assume that the service we are performing is fully computable. Then it would be possible to use proofs of correctness of computations~\cite{ben-sassonSNARKsVerifyingProgram2013} to enforce that only correct computations (and hence correct services) are accepted. This would require the entire service verification to be computable, which is difficult to achieve in settings where physical materials (such as blood) are examined. Specifically, the problem boils down to ``How to represent blood digitally?'' If we could represent urine, blood, saliva or any other physical material in a binary format and let the customer take a sample, discrete it and send it to the SP, then the whole chain of integrity could be ensured. This would make it impossible to provide the wrong service and therefore avoid disputes.

\subsection{Self-sovereign identities}
Our research in this area has shown that some jurisdictions require SPs to link the diagnosis to the customer's personal data. For example, in Poland, all laboratories performing medical diagnostic tests and collecting the material (except for HIV tests) are required to uniquely identify and verify the identity of the patient from whom the material was collected~\cite{ministerstwozdrowiaRegulationMinisterHealth2006}.

This conflicts with the main aim of our protocol, which is to prevent the collection of any identifying information.

A promising solution would be to use self-sovereign identities (SSIs)~\cite{muhleSurveyEssentialComponents2018}, especially the verifiable claims. A trusted authority (e.g. a government) would issue a one-time claim for the customer, which would be accepted by the SP as a legitimate personal identification. The SP would associate the diagnosis result with the provided DID. The DID itself would contain no personal information, so the SP would learn nothing about the customer's identity beyond the random-looking identification. The DID could be de-anonymised in cooperation with the government.

However, as SSI is a relatively new technology and the government has not yet adopted it, we decided to leave the discussion of this topic for future work.

\subsection{Formal Verification}\label{sec:formal-verification}
Following the work of~\cite{birjoveanuFormalVerificationMultiparty2022}, the security analysis of our protocol could be improved by using automatic formal verification tools, such as AVISPA~\cite{armandoAVISPAToolAutomated2005}. It would require the specification of the protocol using the High-Level Protocol Specification Language (HLPSL)~\cite{chevalierHighLevelProtocol2004}. The specification would then be translated into the AVISPA intermediate language and verified using the AVISPA theorem prover. The verification would be performed by the AVISPA model checker, which would check the protocol against the security properties.

\section{Conclusions}\label{sec:conclusion}
In this work, we have focused on enabling the provision of services without the collection of personal data. Our aim was to enable services such as genetic testing, testing for paternity, venereal diseases, HIV, drugs and steroids, or anonymous legal advice.

We found that the current state of the art was not sufficient to achieve this goal. We have therefore proposed a service delivery protocol that simultaneously achieves anonymity, fairness, dispute resolution, TTP-lessness and supports physical materials.

Payments are made in either cash or anonymous cryptocurrencies. The result of the service is published on a content-addressable p2p network. The dispute can be resolved by submitting the collected evidence to the dispute resolution service. 

Using the Definition~\ref{def:fairness}, we showed that the protocol achieves fairness by publishing proof of delivery, proof of payment, and proof of provisioning on the message board. 

Finally, we identified other improvements such as decentralised dispute resolution, self-sovereign identifiers, and anonymous courier delivery.

\paragraph{Data availability}
No data was used for the research described in the article.
The prototype is available at \url{https://anonser.stan.bar}. 
The source code is available at \url{https://github.com/stanbar/anonser}.

\section*{Declarations}

\paragraph{Conflict of interest} The authors declare that they have no competing interests. The authors certify that they have no affiliations with or involvement in any organisation or entity with any financial interest or non-financial interest in the subject matter or materials discussed in this manuscript.

\paragraph{Ethical approval} This article does not contain any studies with human participants or animals performed by any of the authors


\appendix

\section{Proof of fairness}\label{app:proof-of-fairness}
Below we describe each step and the reasoning behind the outcome position.
We use the notation introduced in Section~\ref{sec:fairness-model} to analyse each position in the protocol and the fairness Definition~\ref{def:fairness} to show the fairness of the protocol.

\newcommand{\AgreeablePath}{Agreeable path:}
\newcommand{\DisputePath}{The customer starts a dispute:}
\newcommand{\Fairness}{Fairness:}
\newcommand{\CustomerTurn}[0]{\expandafter\MakeUppercase customer turn:}
\newcommand{\SPTurn}[0]{\sp{} turn:}

\newcommand{\CanFollowToOne}[2]{The #1 can follow the protocol to the non-disadvantaged position #2}
\newcommand{\CanDoNothing}[1]{The #1 can do nothing and always ends up in the non-disadvantaged position}
\newcommand{\CanDoAnything}[1]{The #1 can do anything and always ends up in the non-disadvantaged position}
\newcommand{\Pos}[4]{$\operatorname{\sigma_{#1, #2, #3} = #4}$}
\newcommand{\WinForTheSameReason}[1]{The #1 wins the dispute for the same reason}
\newcommand{\LoseForTheSameReason}[1]{The #1 loses the dispute for the same reason}
\newcommand{\ActedAbnormallyThen}[1]{The #1 acted abnormally, then:}
\newcommand{\CustomerPaidButDidntGetResult}{The customer ends up in a disadvantageous position, because he has paid in advance, but hasn't received the result}
\newcommand{\SpReceivedThePayment}{The SP ends up in the advantageous position, having received the payment}

\newcommand{\CustomerLosesBeforePayment}{The customer loses the dispute because the SP is not obliged to do anything until the transaction is paid}
\newcommand{\CustomerLosesBeforePoP}{The customer loses the dispute because the SP is still able to publish the PoP within the agreed timeframe}

\newcommand{\RemainsIn}[2]{The #1 remains in the #2 position}

\subsubsection*{Step 1. \CustomerTurn{} Package delivery}\label{step-1-deliver-package}

The protocol starts when the customer correctly completes the first step of the protocol, i.e. delivers the package to the SP. 

The case where the customer does not deliver the package is not considered as it is not part of the protocol.

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item  \Pos{1}{c}{\normal}{\neutral}, the customer risked his materials but did not pay for the transaction and therefore ends up in a neutral position (see Assumption 10. in Section \ref{sec:assumptions}).
    \item \Pos{1}{s}{\normal}{\neutral}, the SP ends up in a neutral position as she did not spend any resources and the package did not bring her any value.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{1}{c}{\dispute}{\minus}, \CustomerLosesBeforePayment{}.
    \item \Pos{1}{s}{\dispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\Fairness

\begin{itemize}
  \item \CanFollowToOne{customer}{\Pos{1}{c}{n}{\neutral}}
  \item \CanDoNothing{SP}
\end{itemize}

\subsubsection*{Step 2. \SPTurn{} Proof of Delivery}\label{step-2-proof-of-delivery}

The SP publishes the PoD, then:

\begin{itemize}
  \item \AgreeablePath
    \begin{itemize}
      \item \Pos{2}{c}{\normal}{\neutral}, the customer remains in the neutral position as the PoD allows him to pay for the transaction but does not oblige him to do anything.
      \item \Pos{2}{s}{\normal}{\neutral}, the SP remains in the neutral position as the package has not brought her any value and she has not spent any resources to provide the service.
    \end{itemize}

  \item \DisputePath
    \begin{itemize}
      \item \Pos{2}{c}{\dispute}{\minus}, \CustomerLosesBeforePayment{}.
      \item \Pos{2}{s}{\dispute}{\neutral}, \WinForTheSameReason{SP}.
    \end{itemize}
\end{itemize}

\ActedAbnormallyThen{\sp}

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{2}{c}{\abnormal}{\neutral}, the customer remains in the neutral position as he is not obliged\footnote{By not obliged we understand the situation where a party does not risk any resources by not taking the action} to agree with the incorrect $\mathrm{PoD}$.
    \item \Pos{2}{s}{\abnormal}{\neutral}, the SP remains in the neutral position as the package has not brought her any value and she has not spent any resources to provide the service.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{2}{c}{\abdispute}{\minus}, \CustomerLosesBeforePayment{}, not even to publish correct $\mathrm{PoD}$.
    \item \Pos{2}{s}{\abdispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\Fairness

\begin{itemize}
  \item \CanDoAnything{SP}.
  \item customer can either wait (if the SP is following the protocol) or abandon the transaction (if the SP is acting abnormally). In both cases the customer ends up in a non-disadvantaged position \Pos{2}{c}{\normal}{\neutral} or \Pos{2}{c}{\abnormal}{\neutral}.
\end{itemize}


\subsubsection*{Step 3. \CustomerTurn{} Get Proof of Delivery}\label{step-3-get-proof-of-delivery}

The customer got the \PoD, then:

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{3}{c}{\normal}{\neutral}, \RemainsIn{customer}{neutral}.
    \item \Pos{3}{s}{\normal}{\neutral}, \RemainsIn{SP}{neutral}.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{3}{c}{\dispute}{\minus}, \CustomerLosesBeforePayment{}.
    \item \Pos{3}{s}{\dispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\ActedAbnormallyThen{Customer}

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{3}{c}{\abnormal}{\neutral}, \RemainsIn{customer}{neutral}.
    \item \Pos{3}{s}{\abnormal}{\neutral}, \RemainsIn{SP}{neutral}.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{3}{c}{\abdispute}{\minus}, \CustomerLosesBeforePayment{}.
    \item \Pos{3}{s}{\abdispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\Fairness

\begin{itemize}
  \item \CanFollowToOne{customer}{\Pos{3}{c}{\normal}{\neutral}}.
  \item \CanDoNothing{SP}.
\end{itemize}



\subsubsection*{Step 4. \CustomerTurn{} Payment}

The customer paid the transaction, then:

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{4}{c}{\normal}{\minus}, the customer has paid in advance.
    \item \Pos{4}{s}{\normal}{\plus}, the SP has received the payment but has not spent his resources yet.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{4}{c}{\dispute}{\minus}, \CustomerLosesBeforePoP{}.
    \item \Pos{4}{s}{\dispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\ActedAbnormallyThen{Customer}

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{4}{c}{\abnormal}{\neutral}, the customer ends up in the neutral position as he has not spent his funds.
    \item \Pos{4}{s}{\abnormal}{\neutral}, the SP ends up in the neutral position as she neither received the payment nor spent her resources.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{4}{c}{\abdispute}{\minus}, \CustomerLosesBeforePayment{}.
    \item \Pos{4}{s}{\abdispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\Fairness

\newcommand{\CustomerRiskTemporaryDisadvantagedPosition}[1]{The customer, following the 9th assumption described in Section~\ref{sec:assumptions}, risks the temporary disadvantaged position #1 in favour of a later better position \Pos{9}{s}{\normal}{\plus}; in the meantime, he can get out of the disadvantaged position if the SP misbehaves in any of the following steps.}

\begin{itemize}
  \item \CustomerRiskTemporaryDisadvantagedPosition{\Pos{4}{c}{\normal}{\minus}}.
  \item \CanDoNothing{SP}.
\end{itemize}



\subsubsection*{Step 5. \SPTurn{} Provision of service}

The \sp{} did the provision of service, then:

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{5}{c}{\normal}{\minus}, \RemainsIn{Customer}{disadvantaged} as he hasn't received the result.
    \item \Pos{5}{s}{\normal}{\plus}, \RemainsIn{\sp}{advantaged} as she has received the payment.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{5}{c}{\dispute}{\minus}, \CustomerLosesBeforePoP{}.
    \item \Pos{5}{s}{\dispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\ActedAbnormallyThen{\sp}

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{5}{c}{\abnormal}{\minus}, \CustomerPaidButDidntGetResult{}. 
    \item \Pos{5}{s}{\abnormal}{\plus}, \SpReceivedThePayment{}.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{5}{c}{\abdispute}{\neutral} The customer wins the dispute because the SP has not provided the service within the time agreed in the \PoD{}, and therefore the SP is unable to upload the result and publish the \PoP{} on time.
    \item \Pos{5}{s}{\abdispute}{\minus}, \LoseForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\Fairness
\newcommand{\SPCanDoBothButFollowIsSafe}[1]{The SP can follow the protocol and move to the advantaged position \Pos{#1}{s}{\normal}{\plus}, or act abnormally (not provide the service) and also move to the advantaged position \Pos{#1}{s}{\abnormal}{\plus}; however, the second option puts her at risk of terminating the protocol at \Pos{#1}{s}{\abdispute}{\minus} if the customer is rational and starts a dispute; hence, the SP should choose the first option}

\begin{itemize}
  \item \CustomerRiskTemporaryDisadvantagedPosition{\Pos{5}{c}{\normal}{\minus}}.
  \item \SPCanDoBothButFollowIsSafe{5}.
\end{itemize}

\subsubsection*{Step 6. \SPTurn{} Upload result}\label{step-6-publication-of-results}

The SP uploaded the result on time, then:

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{6}{c}{\normal}{\minus}, \RemainsIn{Customer}{disadvantaged} as he has not received the result.
    \item \Pos{6}{s}{\normal}{\plus}, \RemainsIn{SP}{advantaged} as she has received the payment.
      \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{6}{c}{\dispute}{\minus}, \CustomerLosesBeforePoP{}.
    \item \Pos{6}{s}{\dispute}{\neutral}, \WinForTheSameReason{SP}.

  \end{itemize}
\end{itemize}

\ActedAbnormallyThen{\sp}

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{6}{c}{\abnormal}{\minus}, \CustomerPaidButDidntGetResult{}.
    \item \Pos{6}{s}{\abnormal}{\plus}, \SpReceivedThePayment{}.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{6}{c}{\abdispute}{\neutral}, the customer wins the dispute because the SP has not uploaded the service within the time agreed in the \PoD{} and the SP will not be able to publish the \PoP{} on time.
    \Pos{6}{s}{\abdispute}{\minus}, \LoseForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\Fairness

\begin{itemize}
  \item \CustomerRiskTemporaryDisadvantagedPosition{\Pos{6}{c}{\normal}{\minus}}.
  \item \SPCanDoBothButFollowIsSafe{6}.
\end{itemize}

\subsubsection*{Step 7. \SPTurn{} Proof of provision}\label{step-7-publication-of-proof-of-provision}

The SP published \PoP{} on time, then:

\newcommand{\CustomerLosesBecauseSPCanProveBeingCorrect}{the customer loses the dispute as the \sp{} has published all evidences to prove her correct behaviour}

\begin{itemize}
  \item \AgreeablePath
    \begin{itemize}
      \item \Pos{7}{c}{\normal}{\minus}, the customer has not received the result. Therefore, he remains in a disadvantaged position. 
      \item \Pos{7}{s}{\normal}{\plus}, the SP has published all the evidence to prove her correct behaviour, so she remains in an advantageous position for the rest of the protocol.
    \end{itemize}
  \item \DisputePath
    \begin{itemize}
      \item \Pos{7}{c}{\dispute}{\minus}, \CustomerLosesBecauseSPCanProveBeingCorrect{}.
      \item \Pos{7}{s}{\dispute}{\plus}, \WinForTheSameReason{SP}.
    \end{itemize}
\end{itemize}

\ActedAbnormallyThen{\sp}

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{7}{c}{\abnormal}{\minus}, \CustomerPaidButDidntGetResult{}.
    \item \Pos{7}{s}{\abnormal}{\plus}, \SpReceivedThePayment{}.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{7}{c}{\abdispute}{\neutral}, the customer wins the dispute because the SP did not publish the correct \PoP{} on time.
    \item \Pos{7}{s}{\abdispute}{\minus}, \LoseForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\Fairness

\begin{itemize}
  \item \CustomerRiskTemporaryDisadvantagedPosition{\Pos{7}{c}{\normal}{\minus}}.
  \item \SPCanDoBothButFollowIsSafe{7}.
\end{itemize}


\subsubsection*{Step 8. \CustomerTurn{} Get Proof of Provision}\label{step-8-pull-proof-of-provision}

The customer got the \PoP{}, then:

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{8}{c}{\normal}{\minus}, the customer gets the \cid{}, but not the result yet.
    \item \Pos{8}{s}{\normal}{\plus}, \RemainsIn{\sp}{advantaged}.
  \end{itemize}
\item \DisputePath

  \begin{itemize}
    \item \Pos{8}{c}{\dispute}{\minus}, \CustomerLosesBecauseSPCanProveBeingCorrect{}.
    \item \Pos{8}{s}{\dispute}{\plus}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\ActedAbnormallyThen{Customer}

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{8}{c}{\abnormal}{\minus}, the customer has paid for the transaction but does not have access to the $cid$ and therefore cannot get the result from the storage network.
    \item \Pos{8}{s}{\abnormal}{\plus}, \SpReceivedThePayment{}.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{8}{c}{\abdispute}{\minus}, \CustomerLosesBecauseSPCanProveBeingCorrect{}
    \item \Pos{8}{s}{\abdispute}{\neutral}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}


\Fairness

\begin{itemize}
  \item \CustomerRiskTemporaryDisadvantagedPosition{\Pos{8}{c}{\normal}{\minus}}.
  \item \CanDoNothing{} \Pos{8}{s}{\normal}{\plus} or \Pos{8}{s}{\abnormal}{\plus}.
\end{itemize}

\subsubsection*{Step 9. \CustomerTurn{} Download result}\label{step-9-retrieval-of-results}

The customer downloaded the result, then:

\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{9}{c}{\normal}{\plus}, The customer has received the result, therefore he finishes the protocol in an advantaged position.
    \item \Pos{9}{s}{\normal}{\plus}, \RemainsIn{\sp}{advantaged}.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{9}{c}{\dispute}{\minus}, \CustomerLosesBecauseSPCanProveBeingCorrect{}.
    \item \Pos{9}{s}{\dispute}{\plus}, \WinForTheSameReason{SP}.
  \end{itemize}
\end{itemize}

\ActedAbnormallyThen{Customer}


\begin{itemize}
\item \AgreeablePath
  \begin{itemize}
    \item \Pos{9}{c}{\abnormal}{\minus}, the customer ends up in a disadvantaged position, as he ends up with the incorrect result.
    \item \Pos{9}{s}{\abnormal}{\plus}, the SP ends up in the advantageous position of having received the payment but not having spent his resources.
  \end{itemize}
\item \DisputePath
  \begin{itemize}
    \item \Pos{9}{c}{\abdispute}{\neutral}, the customer wins the case and ends up in the neutral position.
    \item \Pos{9}{s}{\abdispute}{\minus}, the SP loses the case and ends up in the disadvantaged position.
  \end{itemize}
\end{itemize}

\Fairness

\begin{itemize}
  \item \CanFollowToOne{Customer}{\Pos{9}{c}{\normal}{\plus}}.
  \item \CanDoNothing{} \Pos{9}{s}{\normal}{\plus} or \Pos{9}{s}{\abnormal}{\plus}. 
\end{itemize}

\bibliographystyle{spbasic}
\bibliography{bibliography}

\end{document}